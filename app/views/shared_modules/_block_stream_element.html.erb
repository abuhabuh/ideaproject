<% idea_owner = User.find(idea.creator) %>

<div class='block-stream-element-container'>

  <div class='block-stream-element-description-block'>
    <div class='block-stream-element-description-owner-pic'>
      <%= render :partial => '/users/profile_pic', :locals => {:current_user => idea_owner, :path => user_path(idea_owner.id), :makelink => true} %>
    </div>
    <span class='block-stream-element-owner-name'><%=idea_owner.first_name %>:</span> &nbsp;<%=link_to idea.text, idea_path(idea.id), {:method => 'get'}%>
    
  </div>

  <div class='block-stream-element-picture'>
    <%= link_to image_tag(idea.photo.url(:original)),
              idea_path(idea.id),
              {:method => 'get'} %>
  </div>

  <div class='block-stream-element-stats-block'>
    <div class='block-stream-element-stats-block-text'>
      <div id="<%=ID_TAG_AUTH_HOME_STREAM_NUM_USERS+idea.id.to_s%>">
        <%=idea.num_users_joined%> users sharing
      </div>
      <div>
        <%= current_user.friendships
                             .joins('INNER JOIN user_ideas ON friendships.friend_id = user_ideas.user_id')
                             .where('user_ideas.idea_id = ?', idea.id)
                             .count %> friends sharing
      </div>
    </div>

    <div class='block-stream-element-stats-block-action'>
      <% unless @user_idea_ids.include?(idea.id.to_s) %>
        <%= render :partial => "shared_modules/button_add_idea",
                   :locals => {:idea_id => idea.id, :float => 'right'} %>
      <% else %>
        <%= render :partial => "shared_modules/button_chat_idea",
                   :locals => {:idea_id => idea.id, :float => 'right'} %>
      <% end %>
    </div>
  </div>

  <div class='block-stream-element-chat-msg-block'>
    <% messages = ChatMessage.where("idea_id = ?", idea.id).order("id DESC").limit(IDEA_LAYOUT_BLOCK_NUM_CHATS).reverse %>

    <% messages.each do |message| %>
      <div class='block-stream-element-chat-msg'>
        <div class='block-stream-element-chat-msg-pic'>
          <% msg_owner = User.find(message.user_id) %>
          <%= render :partial => '/users/profile_pic', :locals => {:current_user => msg_owner, :path => user_path(msg_owner.id), :makelink => true} %>
        </div>
        <%= msg_owner.first_name %>: <%= message.text %>
      </div>
    <% end %>
  </div>

</div>
