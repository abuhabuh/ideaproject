<% content_for :head do %>
  <%= javascript_include_tag "http://js.pusherapp.com/1.9/pusher.min.js" %>

  <script type="text/javascript">
    
		$(document).ready(function(){
      $("div#<%=ID_TAG_IDEA_CHAT+@idea.id.to_s%>").prop({
        scrollTop: $("div#<%=ID_TAG_IDEA_CHAT+@idea.id.to_s%>").prop("scrollHeight")
      });

			pusher = new Pusher('<%=Pusher.key%>');
			chat_presence_channel = pusher.subscribe('<%=PUSHER_CHANNEL_PREFIX_IDEA + @idea.id.to_s%>');
					 
			chat_presence_channel.bind('<%=PUSHER_CHAT_MSG_EVENT%>',
				function(data) {
					eval(data);
				}
			);
			
			chat_presence_channel.bind('pusher:subscription_succeeded', function(members){
				$('#people_chatting').html("");
				       
				// this is not working TODO: fix this
				members.each(function(member){
					add_member(member.id, member.info.name);
				});
			});

			chat_presence_channel.bind('pusher:member_removed', function(member){
				$('#member_' + member.id).replaceWith("");
			});

			chat_presence_channel.bind('pusher:member_added', function(member){
				add_member(member.id, member.info.name);
			});
			
		});

		function add_member(user_id, name) {
			var content = '<li id=member_' + user_id + '>' + name + '</li>';
			$('#people_chatting').append(content);
		}

  </script>
<% end %>


<table>
  <tr>
    <!-- Left users list block -->
    <td>
      <p>
        <%= image_tag @idea.photo.url(:thumb)%>
        <br/>
        
        <% if @curr_user_idea_link.nil? %>
          <!-- TODO: NEED TO MAKE NEW PARTIAL THAT DOESN'T DIRECT TO HOME CONTROLLER AJAX -->
          <%= render :partial => 'home/idea_action_add', :locals => {:idea_id => @idea.id} %>
        <% else %>
          <%= link_to 'Make an Event! (events coming soon)', '#' %>
        <% end %>
      </p>
      
      People Sharing: 
      <% @idea.users.each do |user| %>
        <%= link_to image_tag(user.profile_pic.url(:stream)),
                            user_path(user.id),
                            {:method => 'get'} %><br/>
        <%= link_to user.user_name, user_path(user.id), {:method => 'get'} %><br/>
        <br/>        
      <% end %>
    </td>
    
    <!-- Right main content block -->
    <td>
      <p>
        <b>Text:</b>
        <%= @idea.text %><br/>
        <%= link_to 'edit idea', edit_idea_path(@idea), {:method => 'get'}%>
      </p>
      
      <br/>
      <br/>
      
      <div>
      
        <table>
					<tr>
						<td>
							<b>Chat Board </b><br/>
							Talk about the idea! Create an event when you're ready to plan time, place, etc.<br/>
							<!-- idea chat window ID is "idea_chat_<##>" where <##> is unique DB idea id -->
							<div id = <%=ID_TAG_IDEA_CHAT+"#{@idea.id}"%>
									 style="border : solid 2px #adadad; background : #ffffff;
													color : #000000; padding : 4px; height : 220px;
													overflow : auto;" >
								<% @idea_chat_msgs.each do |msg| %>
									<!-- TODO: break this out to a render call for each chat text? efficiency? -->
									<%= msg.user.user_name %>: <%= msg.text %> <br/>
								<% end %>
							</div>
						</td>
						<td>
							<u>Online:</u><br />
							<ul>
								<div id = 'people_chatting'></div>
							</ul>
						</td>
					</tr>
				</table>	
      
        <% @chat_message = ChatMessage.new %>
        <%= form_for @chat_message, :remote => true do |f| %>
          <!-- TODO: fix this table hack layout with CSS and div (and all other formatted table hacks) -->
          <table>
            <tr>
              <td>
                <div class="message">
                  <%= f.text_field :text, :size=>"70" %>
                </div>
                <div class="idea_id">
                  <%= f.hidden_field :idea_id, :value => @idea.id %>
                </div>
                <div class="user_id">
                  <%= f.hidden_field :user_id, :value => current_user.id %>
                </div>
              </td>
              <td>
                <div class="actions">
                  <%= f.submit "Send" %>
                </div>
              </td>
            </tr>
          </table>
        <% end %>
      
      </div>
    </td>
  </tr>
</table>
  
