<% content_for :head do %>
  <%= javascript_include_tag "http://js.pusherapp.com/1.9/pusher.min.js" %>
  <script src="/assets/external/jquery.tools.min.js"></script>

  <script type="text/javascript">
   
    // Keep array of user's friends' ids in js memory
    var friend_ids_str = "<%= @friend_ids_str %>";
    var friend_ids_array = friend_ids_str.split(',');
    var public_view = true;
    
    // Functions that are bound to the facebox deals search buttons: search, prev, next
    //   Each function calls the master submitDealsSearchFirst function
    function submitDealsSearchFirst(){
      submitDealsSearch(1);
      return false;
    }
    function submitDealsSearchNext(){
      var max_pages = parseInt($(".deals_search_results_max_page").html());
      var current_page = parseInt($(".deals_search_results_current_page").html());
      
      if (current_page < max_pages){
        submitDealsSearch(current_page + 1);
      }
    }
    function submitDealsSearchPrev(){
      var max_pages = parseInt($(".deals_search_results_max_page").html());
      var current_page = parseInt($(".deals_search_results_current_page").html());
      
      if (current_page > 1){
        submitDealsSearch(current_page - 1);
      }
    }
    
    // Submits AJAX request to server to bring back deal search results. 
    //   search_page specifies page to bring back in page results
    //   "deals_search_form" class is class name of deal search form declared in deals/_deal_search_popup.html.erb
    //   "deal-search-results-section" class is also specified in deals/_deal_search_popup.html.erb
    function submitDealsSearch(search_page){
      $target_form = null;
      $(".deals_search_form").each( function(index){
        // TODO: CHECK THIS IS ALWAYS TRUE - Assuming facebox form is 2nd in list of each function so id should be 1
        if (index == 1){
          $target_form = this; // 'this' refers to form that is found
        }
      });
      
      var params_data = $($target_form).serialize();
      params_data = params_data + "&search_page_num=" + search_page.toString();

      // ajax GET request to server from the facebox form that was cloned and rendered
	    $.ajax({
        url: $($target_form).attr('action'), 
        data: params_data, 
        dataType: 'html',
        success: function(returned_html){
          $(".deal-search-results-section").html(returned_html);
          
          // bind each <add deal> link to ajax call to add deal to idea
          $(".deal-search-result-action").click( function() {
            $.post("<%=idea_deals_path%>", 
                   {idea_id: <%=@idea.id%>, deal_id: $(".deal_id_from_search",this).html()}, // 'this' refers to link that was clicked
                   null,
                   "script"
            );                
          });
          
          // Show previous and next links
          var max_pages = parseInt($(".deals_search_results_max_page").html());
          var current_page = parseInt($(".deals_search_results_current_page").html());

          if ( max_pages > 1 ){
            if (current_page > 1){
              $(".deals_search_previous_link").html("\<a href='#'\>prev\<\/a\>");
            }else{
              $(".deals_search_previous_link").html("prev");
            }
            if (current_page < max_pages){
              $(".deals_search_next_link").html("\<a href='#'\>next\<\/a\>");
            }else{
              $(".deals_search_next_link").html("next");            
            }
            
            $(".deals_search_previous_link").show();
            $(".deals_search_next_link").show();
          }
        }//,
        //error: function(msg){ // TODO: remove this for live deploy
        //  alert(msg);
        //}
      });
    }

    // Deals facebox control bindings
    $(document).bind('reveal.facebox', function() {
      /* BIND submit action on new deal creation form to this function
           - "new_dea" class is auto generated by new deal _form partial
           NOTE: this action is bound to both the original form and the 
           cloned form in facebox */
			$(".new_deal").submit( function(){
        // we are in the context of the form that is displayed by facebox because the button
        //   that was clicked belongs to the form
        // submit AJAX request and set return type to be jQuery which will be executed
        $.post($(this).attr('action'), $(this).serialize(), null, "script");
			  // close facebox window
			  $(document).trigger('close.facebox')

			  return false;
			});
			
			/* BIND submit action on deals search form to ajax get call to deals index action
			 */
			$(".deals_search_form").submit(submitDealsSearchFirst);
			$(".deals_search_previous_link").click(submitDealsSearchPrev);
			$(".deals_search_next_link").click(submitDealsSearchNext);
    });
    // clean up the hidden search form after facebox is closed
    $(document).bind('afterClose.facebox', function() {
    
      $(".deal-search-results-section").html("");
      $(".deals_search_previous_link").hide();
      $(".deals_search_next_link").hide();
    
    });
    // End deals facebox control bindings
    
    
    
		$(document).ready(function(){
		
      // Bind view deals on-click function
      $('#JQUERY-view-deals-link').bind('click', function() {
        if ($('#JQUERY-deals-section').css('display') == "none"){
          $('#JQUERY-deals-section').show('slow');
          $('#JQUERY-view-deals-link').html("Hide");         
          //$('.chat-board-container').height(100);
        } else {
          $('#JQUERY-deals-section').hide('slow');
          $('#JQUERY-view-deals-link').html("Show");
          //$('.chat-board-container').height(230);
        }
      });

      // Open facebox on <a> link click
      $.facebox.settings.closeImage = '/assets/closelabel.png'
      $.facebox.settings.loadingImage = '/assets/loading.gif'
      $('a[rel*=facebox]').facebox()
      
		  // <BEGIN> Pusher chat functions
      $("div#<%=ID_TAG_IDEA_CHAT+@idea.id.to_s%>").prop({
        scrollTop: $("div#<%=ID_TAG_IDEA_CHAT+@idea.id.to_s%>").prop("scrollHeight")
      });

			pusher = new Pusher('<%=Pusher.key%>');
			chat_presence_channel = pusher.subscribe('<%=PUSHER_CHANNEL_PREFIX_IDEA + @idea.id.to_s%>');
					 
			chat_presence_channel.bind('<%=PUSHER_CHAT_MSG_EVENT%>',
				function(data) {
					eval(data);
				}
			);
			
			chat_presence_channel.bind('pusher:subscription_succeeded', function(members){
				$('#people_chatting').html("");

				members.each(function(member){				
  				if ($('#<%=ID_TAG_IDEA_USER%>' + String(member.id)).length ) {
					  member_online(member.id);
					} else {
            if (render_user(member.id)){
              add_user_to_list(member.id);
            }
					}
				});
				
			});

			chat_presence_channel.bind('pusher:member_removed', function(member){
				if ($('#<%=ID_TAG_IDEA_USER%>' + String(member.id)).length ) {
				  member_offline(member.id);
				}
			});

			chat_presence_channel.bind('pusher:member_added', function(member){
				if ($('#<%=ID_TAG_IDEA_USER%>' + String(member.id)).length ) {
				  member_online(member.id);
				} else {				
          if (render_user(member.id)) {
            add_user_to_list(member.id);
				  }
				}
			});
  	  // <END> Pusher chat functions
			
	    // Function for re-rendering user chat list	(want to load this after pusher presence channel is established)
		  function render_user_list(public_view_boolean){
		    $.ajax({
          url: "<%=idea_chat_user_list_path%>", 
          data: {idea_id : <%=@idea.id%>, friends_only : !public_view_boolean, friend_ids_str : friend_ids_str}, 
          dataType: 'html',
          success: function(returned_html){
            $("#<%=ID_TAG_IDEA_CHAT_USER_LIST%>").replaceWith(returned_html);
            public_view = public_view_boolean;
   
            // set chat channel members to online
		        chat_presence_channel.members.each(function(member){
      				if ($('#<%=ID_TAG_IDEA_USER%>' + String(member.id)).length ) {
					      member_online(member.id);
					    }else{
  		          if (render_user(member.id)){
  		            add_user_to_list(member.id);
  		          }
  		        }
		        });
		  
		        // set highlighting
            $('#user_filter_public').css('text-decoration', 'none');
            $('#user_filter_friends').css('text-decoration', 'none');
            $('#user_filter_public').unbind('click');
            $('#user_filter_friends').unbind('click');

            // if view type of user list window is public
            if (public_view){
              $('#user_filter_friends').css('text-decoration', 'underline');
			        $('#user_filter_friends').click(function(){
			          render_user_list(false);
			        });
			   			$('#user_filter_friends').mouseover(function () {
              	$(this).css('cursor', 'pointer');
              });
			   			$('#user_filter_public').mouseover(function () {
              	$(this).css('cursor', 'auto');
              });
            }else{
              $('#user_filter_public').css('text-decoration', 'underline');
			        $('#user_filter_public').click(function(){
          			render_user_list(true);
			        });
			   			$('#user_filter_friends').mouseover(function () {
              	$(this).css('cursor', 'auto');
              });
			   			$('#user_filter_public').mouseover(function () {
              	$(this).css('cursor', 'pointer');
              });
            }
          }//,
          //error: function(msg){ // remove this for live deploy
          //  alert(msg);
          //}
        });
		  }
			
			// bind public and friend user list filters to functions
			$('#user_filter_friends').mouseover(function () {
      	$(this).css('cursor', 'pointer');
      });
      $('#user_filter_friends').css('text-decoration', 'underline');
			$('#user_filter_friends').click(function(){
			  render_user_list(false);
			});
		});

    // Take in member id and see if user should be rendered based on public view / friend view and user's friend list
    function render_user(member_id){
      if (!public_view &&
          $.inArray(String(member_id), friend_ids_array) == -1){
        return false;
      }
      return true;
    }

    function add_user_to_list(member_id){
      $.ajax({
          url: "<%=idea_chat_user_path%>", 
          data: {user_id : member_id, user_status : "<%=ID_TAG_CHAT_USER_VIEWING_STRING%>", idea_id : <%=@idea.id%>}, 
          dataType: 'html',
          success: function(returned_html){
            $("#<%=ID_TAG_IDEA_CHAT_USER_LIST%>").prepend(returned_html);
          }//,
          //error: function(msg){ // remove this for live deploy
          //  alert(msg);
          //}
        });
    }

		function member_online(user_id) {
  		$('#<%=ID_TAG_IDEA_USER%>' + String(user_id)).removeClass('chat-board-user-item-status-offline');
      $('#<%=ID_TAG_IDEA_USER%>' + String(user_id)).addClass('chat-board-user-item-status-online');
		}

		function member_offline(user_id) {
      $('#<%=ID_TAG_IDEA_USER%>' + String(user_id)).removeClass('chat-board-user-item-status-online');
  		$('#<%=ID_TAG_IDEA_USER%>' + String(user_id)).addClass('chat-board-user-item-status-offline');
		}
		
		<% if @has_idea %>
		  //////////////////////////////////////////////////////////
		  // This section is for idea want, kick and commit actions
		  //   rendered depending on if user has joined idea
		  //////////////////////////////////////////////////////////
      var want_it_additional_clicks=false; // this counts batches of clicks; interval function picks this up, sends to DB, and clears counter

		  $(document).ready(function(){			
			  // bind want it div to click and turn into button
			  $('#JS_want_it_counter').mouseover(function () {
        	$(this).css('cursor', 'pointer');
        });
			  $('#JS_want_it_counter').click(function(){
          var want_it_count = parseInt($(this).html());
          $(this).html(String(want_it_count + 1));
          want_it_additional_clicks = true;
			  });		
        setInterval(function() {
          send_want_it_counts();
        }, 1000); // TODO: optimize this 1 second delay for function gives ajax to return and make page longer before next at_bottom check 

        // bind commit div to click and turn into button
        $('#JS_commit').mouseover(function() {
          $(this).css('cursor', 'pointer');
        });
			  $('#JS_commit').click(commit_user_to_idea);

        // make mouse over the help icon for all help links
        $('.JS_help_link').mouseover(function () {
          $(this).css('cursor','help');
        });
		  });

      // send commit create to backend database and update page accordingly
      function commit_user_to_idea(){
        $.post("<%=idea_commitments_path%>", {idea_commitment: {user_id: <%=current_user.id%>, idea_id: <%=@idea.id%>}}, null, "script");
      }

      // sends want it counts to backend database and updates counter in person table
      function send_want_it_counts(){
        if (want_it_additional_clicks){
          want_it_additional_clicks = false;

          var want_it_count_update = parseInt($('#JS_want_it_counter').html());
          $.ajax({url: "/user_ideas/"+<%=@curr_user_idea_link.id.to_s%>,
                  type: "PUT",
                  data: {id: "<%=@curr_user_idea_link.id.to_s%>", user_idea: {want_it_count: want_it_count_update}},
                  success: function(return_html){
                    $('#<%=ID_TAG_USER_LIST_USER_ROW+current_user.id.to_s%>')
                      .find('.chat-board-user-item-want-count') // find any sub items with right class
                      .slice(0,1) // take first occurance
                      .html(String(want_it_count_update)); // update
                  },
                  dataType: 'html'});
        }
      }
		  //////////////////////////////////////////////////////////
		  // End join dependent section
		  //////////////////////////////////////////////////////////
    <% end %>
    
  </script>
<% end %>


<!-- id tag to mark this as the IDEAS VIEW page for shared AJAX functions -->
<div class='hidden-div' id='<%=ID_TAG_IDEA_VIEW_PAGE%>'></div>
<!-- Hidden div for facebox rendering for adding deals -->
<div id='FACEBOX_add_deal_container' class='hidden-div'> 
  <% @deal = Deal.new %>
  <%= render :partial => 'deals/form', :locals => {:idea_id => @idea.id} %>
</div>
<!-- Hidden div for facebox rendering for searching deals -->
<div id='FACEBOX_search_deals_container' class='hidden-div'> 
  <%= render :partial => 'deals/deal_search_popup', :locals => {:idea_id => @idea.id} %>
</div>
<div id='FACEBOX_kick_someone_container' class='hidden-div'> 
  <%= render :partial => 'shared_modules/user_picture_list', 
             :locals => {:current_page => 1, 
                         :num_per_page => IDEA_KICK_USERS_NUM_PER_PAGE, 
                         :kickem_users => @kickem_users_list,
                         :num_total_pages => @num_total_pages,
                         :idea_id => @idea.id } %>
</div>
<div id='FACEBOX_commit_help' class='hidden-div'>
  <%= render :partial => 'shared_modules/help_popup_num_commits' %>
</div>
<div id='FACEBOX_want_it_help' class='hidden-div'>
  <%= render :partial => 'shared_modules/help_popup_want_it' %>
</div>
<div id='FACEBOX_kick_help' class='hidden-div'>
  <%= render :partial => 'shared_modules/help_popup_kick' %>
</div>

<div class='left-nav-wide'>

  <div class='idea-view-pic-and-info'>
    <div class='idea-view-pic'>
      <%= image_tag @idea.photo.url(:thumb)%>
    </div>
    <div class='idea-view-info minor-text'>
      <% unless @curr_user_idea_link.nil? %>
        <b>Your Status</b> <br/>
        &nbsp;&nbsp;<b>Do This:</b> <%= UserIdea.time_goal_string(@curr_user_idea_link.time_goal) %>
        <br/>
        &nbsp;&nbsp;<b>Committed?:</b>
        <span id='<%=ID_TAG_IDEA_VIEW_COMMITMENT_STATUS%>'>
          <% if @is_committed %>
            Yes
          <% else %>
            No
          <% end %>
        </span>
      <% else %>
        <!-- TODO: NEED TO MAKE NEW PARTIAL THAT DOESN'T DIRECT TO HOME CONTROLLER AJAX -->
        You're getting left out! <br/>
        <br/>
        <div class="button-styling-major button-float-left">
          <%= link_to BUTTON_JOIN_IDEA,
              add_idea_id_path(:idea_id => @idea.id),
                               {:method => 'post'} %>
        </div>
      <% end %>
    </div>
  </div>

  <div class='content-section'>
    <!-- if no friends, then default public view, else friends view -->
    <div class='content-header'>
        People Sharing
        <span class='minor-text' style='float: right;'> 
          <span id='user_filter_public'>public</span> | <span id='user_filter_friends'>friends</span>
        </span>
    </div>
    
    <div class='user-list-header-row'>
      <div class='user-list-header-row-image'>
        User:
      </div>
      <div class='chat-board-user-item-text'>
        Name:
      </div>
      <div class='chat-board-user-item-want-count'>
        <a href='#FACEBOX_want_it_help' rel='facebox'>
          <span class="JS_help_link">Want Count</span>:
        </a>
      </div>
      <div class='chat-board-user-item-prod-count'>
        <a href='#FACEBOX_kick_help' rel='facebox'>
          <span class="JS_help_link">Times Kicked</span>:
        </a>
      </div>
    </div>
  
    <%= render :partial => 'shared_modules/chat_user_list_left_nav', 
               :locals => {:container_id_tag => ID_TAG_IDEA_CHAT_USER_LIST, 
                           :users => @idea_users, 
                           :chat_type => CHAT_TYPE_IDEA,
                           :topic_id => @idea.id,
                           :friends_only => false,
                           :friend_ids => @friend_ids_str} %>

  </div>
</div>
    

<div class='idea-content-container'>

  <div class='content-title'>
    <%= @idea.text %>
    <span id="<%=ID_TAG_IDEA_EDIT_LINK%>" class='minor-link'>
      <% unless @curr_user_idea_link.nil? %>
        <%= link_to 'edit idea', edit_idea_path(@idea), {:method => 'get'}%>
        <br/>
      <% end %>
    </span>
  </div>
  <span class='minor-text'>Talk about the idea with anyone interested! Find out who you'd like to do it with and motivate the group! </span>
  
  <% if @has_idea %>
    <!-- just taking up some space... -->
    <div class='content-section'>
      <hr>
      
      <div class='idea-view-action-section' style='text-align: center;'>

        <div class='idea-view-action-want-it'>
          <span class='minor-text'>
            <a href='#FACEBOX_want_it_help' rel='facebox'><span class="JS_help_link">Who wants it more</span></a>? Click to take the lead.
          </span>
          <div id='JS_want_it_counter' class='idea-view-action-want-it-button round'>
            <%= @curr_user_idea_link.want_it_count %>
          </div>
        </div>
        <div class='idea-view-action-nudge'>
          <span class='minor-text'>
            <a href='#FACEBOX_kick_help' rel='facebox'><span class="JS_help_link" style="text-decoration: underline;">Sick of waiting around</span></a>? 
            Kick someone into action.
          </span>
          <a href='#FACEBOX_kick_someone_container' rel='facebox'>
            <div class='idea-view-action-nudge-button round'>
              Kick em!
            </div>
          </a>
        </div>
        <div class='idea-view-action-commit'>
          <% if @is_committed %>
            <%= render :partial => 'ideas/make_event_button' %>
          <% else %>
            <% if @can_commit %>
              <span class='minor-text'>
                <a href='#FACEBOX_commit_help' rel='facebox'><span class="JS_help_link">You have <%=(NUM_COMMITS_PER_MONTH - @num_commits_outstanding)%> commits</span></a> left. 
                Commit to motivate others!
              </span>
              
              <div id='JS_commit' class='idea-view-action-commit-button round'>
                Commit
              </div>
            <% else %>
              <span class='minor-text'>
                <a href='#FACEBOX_commit_help' rel='facebox'><span class="JS_help_link">Sorry, you're out of commits</span></a>. 
                Try kicking someone :)
              </span>
              
              <div class='idea-view-action-commit-button round'>
                &nbsp;
              </div>
            <% end %>
          <% end %>
        </div>

      </div>
    
    </div>
  <% end %>

  <div class='content-section'>
    <div class='content-header'>Public Discussion Board</div>
    
	  <!-- idea chat window ID is "idea_chat_<##>" where <##> is unique DB idea id -->
    <%= render :partial => "shared_modules/chat_board", 
               :locals => {:chat_messages => @idea_chat_msgs,
                           :ajax_tag => ID_TAG_IDEA_CHAT+"#{@idea.id}"} %>

    <!-- Message input send form: can't be shared with feedback chat right now because hidden :user_id field
           is different. Well...it could but I'm lazy...
    -->
    <% if @has_idea %>
      <%= render :partial => 'shared_modules/chat_input_bar_ideas'%>
    <% else %>
      <div class='minor-text' id='<%=ID_TAG_IDEA_CHAT_INPUT_AREA%>'>Join the idea to chat!</div>
    <% end %>
  
  </div>

  <div class='content-section'> 
    <div class='content-header'>
      Deals Added by Users

      <span class='button-float-right button-styling-major'>
        <a href='#' id='JQUERY-view-deals-link'> Hide </a>
      </span> 
      <span class='button-float-right button-styling-major'>
        <a href='#FACEBOX_search_deals_container' rel='facebox'> Search Existing Deals </a>
      </span> 
      <span class='button-float-right button-styling-major'>
        <a href='#FACEBOX_add_deal_container' rel='facebox'>Add New Deal</a>
      </span> 
    </div>

    <div id='JQUERY-deals-section'>
      <span class='minor-text'>Browse through deals people added to this Idea and create an event from one! (just kidding, creating events is not implemented yet...)</span> 
      <!-- Deals div --> 
      <div  class='deals-list-container' id='<%=ID_TAG_IDEA_DEALS_LIST_CONTAINER%>'>
        <% @idea_deals.each do |idea_deal| %>
          <%= render :partial => 'deals/deal_element', :locals => {:deal => idea_deal} %>
        <% end %>    
      </div>
    </div>
  </div>

</div>
