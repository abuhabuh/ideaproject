<% content_for :head do %>
  <%= javascript_include_tag "http://js.pusherapp.com/1.9/pusher.min.js" %>
  <script src="/assets/external/jquery.tools.min.js"></script>

  <script type="text/javascript">
    
    // Functions that are bound to the facebox deals search buttons: search, prev, next
    //   Each function calls the master submitDealsSearchFirst function
    function submitDealsSearchFirst(){
      submitDealsSearch(1);
      return false;
    }
    function submitDealsSearchNext(){
      var max_pages = parseInt($(".deals_search_results_max_page").html());
      var current_page = parseInt($(".deals_search_results_current_page").html());
      
      if (current_page < max_pages){
        submitDealsSearch(current_page + 1);
      }
    }
    function submitDealsSearchPrev(){
      var max_pages = parseInt($(".deals_search_results_max_page").html());
      var current_page = parseInt($(".deals_search_results_current_page").html());
      
      if (current_page > 1){
        submitDealsSearch(current_page - 1);
      }
    }
    
    // Submits AJAX request to server to bring back deal search results. 
    //   search_page specifies page to bring back in page results
    //   "deals_search_form" class is class name of deal search form declared in deals/_deal_search_popup.html.erb
    //   "deal-search-results-section" class is also specified in deals/_deal_search_popup.html.erb
    function submitDealsSearch(search_page){
      $target_form = null;
      $(".deals_search_form").each( function(index){
        // TODO: CHECK THIS IS ALWAYS TRUE - Assuming facebox form is 2nd in list of each function so id should be 1
        if (index == 1){
          $target_form = this; // 'this' refers to form that is found
        }
      });
      
      var params_data = $($target_form).serialize();
      params_data = params_data + "&search_page_num=" + search_page.toString();

      // ajax GET request to server from the facebox form that was cloned and rendered
	    $.ajax({
        url: $($target_form).attr('action'), 
        data: params_data, 
        dataType: 'html',
        success: function(returned_html){
          $(".deal-search-results-section").html(returned_html);
          
          // bind each <add deal> link to ajax call to add deal to idea
          $(".deal-search-result-action").click( function() {
            $.post("<%=idea_deals_path%>", 
                   {idea_id: <%=@idea.id%>, deal_id: $(".deal_id_from_search",this).html()}, // 'this' refers to link that was clicked
                   null,
                   "script"
            );                
          });
          
          // Show previous and next links
          var max_pages = parseInt($(".deals_search_results_max_page").html());
          var current_page = parseInt($(".deals_search_results_current_page").html());

          if ( max_pages > 1 ){
            if (current_page > 1){
              $(".deals_search_previous_link").html("\<a href='#'\>prev\<\/a\>");
            }else{
              $(".deals_search_previous_link").html("prev");
            }
            if (current_page < max_pages){
              $(".deals_search_next_link").html("\<a href='#'\>next\<\/a\>");
            }else{
              $(".deals_search_next_link").html("next");            
            }
            
            $(".deals_search_previous_link").show();
            $(".deals_search_next_link").show();
          }
        },
        error: function(msg){ // TODO: remove this for live deploy
          alert(msg);
        }
      });
    }


    $(document).bind('reveal.facebox', function() {
      /* BIND submit action on new deal creation form to this function
           - "new_dea" class is auto generated by new deal _form partial
           NOTE: this action is bound to both the original form and the 
           cloned form in facebox */
			$(".new_deal").submit( function(){
        // we are in the context of the form that is displayed by facebox because the button
        //   that was clicked belongs to the form
        // submit AJAX request and set return type to be jQuery which will be executed
        $.post($(this).attr('action'), $(this).serialize(), null, "script");
			  // close facebox window
			  $(document).trigger('close.facebox')

			  return false;
			});
			
			/* BIND submit action on deals search form to ajax get call to deals index action
			 */
			$(".deals_search_form").submit(submitDealsSearchFirst);
			
			$(".deals_search_previous_link").click(submitDealsSearchPrev);
			
			$(".deals_search_next_link").click(submitDealsSearchNext);
    });

    // clean up the hidden search form after facebox is closed
    $(document).bind('afterClose.facebox', function() {
    
      $(".deal-search-results-section").html("");
      $(".deals_search_previous_link").hide();
      $(".deals_search_next_link").hide();
    
    });
    
    
		$(document).ready(function(){
		  // Setup tabbing
		  $(function() {
      	// setup ul.tabs to work as tabs for each div directly under div.panes
	      $("ul.tabs").tabs("div.panes > div");
      });
		
      /* Bind view deals on-click function */
      $('#JQUERY-view-deals-link').bind('click', function() {
        if ($('#JQUERY-deals-section').css('display') == "none"){
          $('#JQUERY-deals-section').show('slow');
          $('#JQUERY-view-deals-link').html("Hide");         
          //$('.chat-board-container').height(100);
        } else {
          $('#JQUERY-deals-section').hide('slow');
          $('#JQUERY-view-deals-link').html("Show");
          //$('.chat-board-container').height(230);
        }
      });

      /* Open facebox on <a> link click */
      $('a[rel*=facebox]').facebox()

		  /* <BEGIN> Pusher chat functions */		
      $("div#<%=ID_TAG_IDEA_CHAT+@idea.id.to_s%>").prop({
        scrollTop: $("div#<%=ID_TAG_IDEA_CHAT+@idea.id.to_s%>").prop("scrollHeight")
      });

			pusher = new Pusher('<%=Pusher.key%>');
			chat_presence_channel = pusher.subscribe('<%=PUSHER_CHANNEL_PREFIX_IDEA + @idea.id.to_s%>');
					 
			chat_presence_channel.bind('<%=PUSHER_CHAT_MSG_EVENT%>',
				function(data) {
					eval(data);
				}
			);
			
			chat_presence_channel.bind('pusher:subscription_succeeded', function(members){
				$('#people_chatting').html("");
				       
				// this is not working TODO: fix this
				members.each(function(member){				
  				if ($('#<%=ID_TAG_IDEA_USER%>' + String(member.id)).length ) {
					  member_online(member.id);
					} else {
						$.ajax({
                url: "<%=idea_chat_user_path%>", 
                data: {user_id : member.id, user_status : "<%=ID_TAG_CHAT_USER_VIEWING_STRING%>"}, 
                dataType: 'html',
                success: function(returned_html){ // TODO: fix this
                  $("#<%=ID_TAG_IDEA_CHAT_USER_LIST%>").append(returned_html);
                },
                error: function(msg){ // TODO: remove this for live deploy
                  alert(msg);
                }
              });
					}
				});
			});

			chat_presence_channel.bind('pusher:member_removed', function(member){
				if ($('#<%=ID_TAG_IDEA_USER%>' + String(member.id)).length ) {
				  member_offline(member.id);
				}
			});

			chat_presence_channel.bind('pusher:member_added', function(member){
				if ($('#<%=ID_TAG_IDEA_USER%>' + String(member.id)).length ) {
				  member_online(member.id);
				} else {
				  $.ajax({
                url: "<%=idea_chat_user_path%>", 
                data: {user_id : member.id, user_status : "<%=ID_TAG_CHAT_USER_VIEWING_STRING%>"}, 
                dataType: 'html',
                success: function(returned_html){
                  $("#<%=ID_TAG_IDEA_CHAT_USER_LIST%>").prepend(returned_html);
                },
                error: function(msg){ // remove this for live deploy
                  alert(msg);
                }
              });
				
				}
			});
  	  /* <END> Pusher chat functions */
			
		});

		function member_online(user_id) {
  		$('#<%=ID_TAG_IDEA_USER%>' + String(user_id)).removeClass('chat-board-user-item-status-offline');
      $('#<%=ID_TAG_IDEA_USER%>' + String(user_id)).addClass('chat-board-user-item-status-online');
		}

		function member_offline(user_id) {
      $('#<%=ID_TAG_IDEA_USER%>' + String(user_id)).removeClass('chat-board-user-item-status-online');
  		$('#<%=ID_TAG_IDEA_USER%>' + String(user_id)).addClass('chat-board-user-item-status-offline');
		}
  </script>
<% end %>


<!-- id tag to mark this as the IDEAS VIEW page for shared AJAX functions -->
<div class='hidden-div' id='<%=ID_TAG_IDEA_VIEW_PAGE%>'></div>
<!-- Hidden div for facebox rendering for adding deals -->
<div id='FACEBOX_add_deal_container' class='hidden-div'> 
  <% @deal = Deal.new %>
  <%= render :partial => 'deals/form', :locals => {:idea_id => @idea.id} %>
</div>
<!-- Hidden div for facebox rendering for searching deals -->
<div id='FACEBOX_search_deals_container' class='hidden-div'> 
  <%= render :partial => 'deals/deal_search_popup', :locals => {:idea_id => @idea.id} %>
</div>


<div class='left-nav'>
  <div class='idea-image-main'>
    <%= image_tag @idea.photo.url(:thumb)%>
  </div>
  <div class='idea-action-link'>
    <% if @curr_user_idea_link.nil? %>
      <!-- TODO: NEED TO MAKE NEW PARTIAL THAT DOESN'T DIRECT TO HOME CONTROLLER AJAX -->
      <%= render :partial => 'home/idea_action_add', :locals => {:idea_id => @idea.id} %>
    <% else %>
      <%= link_to 'Make an Event! (events coming soon)', '#' %>
    <% end %>
  </div>

  <br />
  
  <div class='content-section'>
    <!-- if no friends, then default public view, else friends view -->
    <div class='content-header'>
        People Sharing
    </div>

    <%= render :partial => 'shared_modules/chat_user_list_left_nav', 
               :locals => {:container_id_tag => ID_TAG_IDEA_CHAT_USER_LIST, :users => @idea.users} %>

  </div>
</div>
    

<div class='content-container'>

  <div class='content-title'>
        <%= @idea.text %>
  </div>
  <span id="<%=ID_TAG_IDEA_EDIT_LINK%>" class='minor-link'>
    <% unless @curr_user_idea_link.nil? %>
      <%= link_to 'edit idea', edit_idea_path(@idea), {:method => 'get'}%>
    <% end %>
  </span>
  
  <!-- just taking up some space... -->
  <div class='content-section'> &nbsp; </div>

  <div class='content-section'>
    <div class='content-header'>Public Chat Board</div>
    <span class='minor-text'>Talk about the idea with anyone interested! Create an event when you're ready to plan time, place, etc.</span>
    
	  <!-- idea chat window ID is "idea_chat_<##>" where <##> is unique DB idea id -->
    <%= render :partial => "shared_modules/chat_board", 
               :locals => {:chat_messages => @idea_chat_msgs,
                           :ajax_tag => ID_TAG_IDEA_CHAT+"#{@idea.id}"} %>

    <!-- Message input send form: can't be shared with feedback chat right now because hidden :user_id field
           is different. Well...it could but I'm lazy...
    -->
    <% if @has_idea %>
      <%= render :partial => 'shared_modules/chat_input_bar_ideas'%>
    <% else %>
      <div class='minor-text' id='<%=ID_TAG_IDEA_CHAT_INPUT_AREA%>'>Join the idea to chat!</div>
    <% end %>
  
  </div>

  <div class='content-section'> 
    <div class='content-header'>
      Deals Added by Users

      <span class='button-float-right button-styling-major'>
        <a href='#' id='JQUERY-view-deals-link'> Hide </a>
      </span> 
      <span class='button-float-right button-styling-major'>
        <a href='#FACEBOX_search_deals_container' rel='facebox'> Search Existing Deals </a>
      </span> 
      <span class='button-float-right button-styling-major'>
        <a href='#FACEBOX_add_deal_container' rel='facebox'>Add New Deal</a>
      </span> 
    </div>

    <div id='JQUERY-deals-section'>
      <span class='minor-text'>Browse through deals people added to this Idea and create an event from one! (just kidding, creating events is not implemented yet...)</span> 
      <!-- Deals div --> 
      <div  class='deals-list-container' id='<%=ID_TAG_IDEA_DEALS_LIST_CONTAINER%>'>
        <% @idea_deals.each do |idea_deal| %>
          <%= render :partial => 'deals/deal_element', :locals => {:deal => idea_deal} %>
        <% end %>    
      </div>
    </div>
  </div>

</div>  

<div class='right-nav'>

  <div class='content-section'>
  
      <div class='content-header'>Events</div>
      
  </div>

</div>
